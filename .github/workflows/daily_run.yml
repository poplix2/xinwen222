name: News Monitor

on:
  schedule:
    # âš ï¸ ä¿®æ”¹è¯´æ˜ï¼š
    # UTC 0-12 ç‚¹ å¯¹åº” åŒ—äº¬æ—¶é—´ 08:00-20:00
    # */30 ä»£è¡¨æ¯ 30 åˆ†é’Ÿè¿è¡Œä¸€æ¬¡
    - cron: '*/30 0-12 * * *'
  workflow_dispatch:

# ç»™ Actions å†™å…¥ä»“åº“çš„æƒé™
permissions:
  contents: write

jobs:
  run-bot:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.9'
          
      # ğŸ’¡ å»ºè®®ï¼šåŠ ä¸Šç¼“å­˜æ­¥éª¤ï¼Œå¯ä»¥å‡å°‘å®‰è£…ä¾èµ–çš„æ—¶é—´ï¼ŒèŠ‚çœ Actions é¢åº¦
      - name: Cache pip packages
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
          
      - name: Install dependencies
        run: pip install -r requirements.txt
          
      - name: Run Monitor
        env:
          FEISHU_WEBHOOK: ${{ secrets.FEISHU_WEBHOOK }}
        run: python main.py

      # æŠŠä¿®æ”¹åçš„ index.html æ¨é€å›ä»“åº“
      - name: Commit and Push Archive
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          # æ£€æŸ¥ index.html æ˜¯å¦æœ‰å˜åŒ–ï¼Œæœ‰å˜åŒ–æ‰æäº¤
          if [ -f index.html ]; then
            git add index.html
            git diff --quiet && git diff --staged --quiet || (git commit -m "Auto update news archive" && git push)
          else
            echo "âš ï¸ index.html was not generated!"
          fi
